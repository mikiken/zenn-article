---
title: "Pythonでエアコンのリモコン信号を解析し自在に操作できるようにする"
emoji: "👋"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["HomeAutomation", "Python"]
published: false
---

この記事は、[CAMPHOR- Advent Calendar 2023](https://advent.camph.net)の5日目の記事です。

## はじめに
この記事は、以下の記事の続きです。
https://zenn.dev/mikiken/articles/decode-ir-signal

前回は、赤外線リモコンの信号をバイナリデータにデコードし、それをパースして以下のように16進数として表記する方法までを説明しました。

```
23cb260100205800c64000000000100000a3
```

この記事では、エアコンのリモコン信号を解析した上で、エアコンの運転状態からリモコン信号を生成する方法について説明します。

## エアコンのリモコン信号解析の難しさ
[前回の記事で説明した方法](https://zenn.dev/mikiken/articles/decode-ir-signal)で、リモコンの各ボタンを押した際の信号を上記のように記録しておき、その信号をそのまま再現して送信すれば、自由にエアコンを操作できると思うかもしれません。

実際、この方法でテレビやシーリングライトなどのリモコン信号を再現することができます。こうした機器のリモコンは、各ボタンに対して決められた信号を送信しているだけだからです。

それに対し、エアコンのリモコン信号は、この方法では再現できません。なぜなら、エアコンのリモコンは、各ボタンに対して決められた信号を送信しているわけではなく、**エアコンの運転状態に応じて毎回異なる信号を送信しているからです**。

端的にいえば、テレビの音量を上げるボタンを押した際に「音量を上げたい」という信号が送信されるのに対し、エアコンの温度を上げるボタンを押すと、「温度を25℃にしたい」「温度を26℃にしたい」のように、その時点でのエアコンの運転状態に応じて異なる信号が送信されます。

さらに詳しく説明すると、エアコンのリモコン信号には、運転モード(冷房, 暖房, ...)、温度、風量、風向といった、**エアコンの運転状態を指定するパラメータが全て含まれています**。「温度を上げる」ボタンを押した際には、風向や風量といったパラメータも送信されているのです。[^1]

[^1]: 昔、「エアコンのリモコンの信号が正しく本体に届かなかった場合、リモコンに表示されている状態と本体側の状態がズレてしまうのではないか?」と思っていました。実際には、次に本体がリモコンの信号を受信したときに、リモコンと本体の状態は正しく同期されていたのです。

すなわち、エアコンのリモコン信号を再現するには、**送信信号のどのフィールドがどのパラメータに対応しているのか**を全て調べる必要があります。

## 実際に信号を解析してみる
上記で述べた通り、送信信号のどのフィールドがどのパラメータの情報が含まれているかを解析していきます。

解析する際のコツは、**解析したいパラメータ(温度,風向, 風量など)1つのみを変更し、他のパラメータは固定しておく**ことです。

こうすることで、デコードされた信号のどの部分が、解析したいパラメータの情報を含んでいるのかを特定しやすくなります。

### 温度を表すフィールドの特定
まず、エアコンのリモコンの設定を、

- 冷房
- 風速:自動
- 風向(上下):自動
- 風向(左右):スイング

にした状態で、温度を16℃(最低温度)から31℃(最高温度)まで順に1℃ずつ上げてみます。
すると、デコードした16進数は次のようになりました。(見やすさのために空白を挿入しました)

```
23 cb 26 01 00 20 58 00 c6 40 00 00 00 00 10 00 00 a3
23 cb 26 01 00 20 58 01 c6 40 00 00 00 00 10 00 00 a4
23 cb 26 01 00 20 58 02 c6 40 00 00 00 00 10 00 00 a5
23 cb 26 01 00 20 58 03 c6 40 00 00 00 00 10 00 00 a6
23 cb 26 01 00 20 58 04 c6 40 00 00 00 00 10 00 00 a7
23 cb 26 01 00 20 58 05 c6 40 00 00 00 00 10 00 00 a8
23 cb 26 01 00 20 58 06 c6 40 00 00 00 00 10 00 00 a9
23 cb 26 01 00 20 58 07 c6 40 00 00 00 00 10 00 00 aa
23 cb 26 01 00 20 58 08 c6 40 00 00 00 00 10 00 00 ab
23 cb 26 01 00 20 58 09 c6 40 00 00 00 00 10 00 00 ac
23 cb 26 01 00 20 58 0a c6 40 00 00 00 00 10 00 00 ad
23 cb 26 01 00 20 58 0b c6 40 00 00 00 00 10 00 00 ae
23 cb 26 01 00 20 58 0c c6 40 00 00 00 00 10 00 00 af
23 cb 26 01 00 20 58 0d c6 40 00 00 00 00 10 00 00 b0
23 cb 26 01 00 20 58 0e c6 40 00 00 00 00 10 00 00 b1
23 cb 26 01 00 20 58 0f c6 40 00 00 00 00 10 00 00 b2
```
このデコード結果を見ると、前から8byte目と最後のbyteが変化していることが分かります。リモコン信号の終端付近のbyteはパリティであることが多いので、前から8byte目が温度を表していそうです。

8byte目の数値そのものに注目してみると、16℃のときに`00`であり、1℃上げるごとに1ずつ増え、31℃のときに`0f`になっていることが分かります。よって、8byte目にセットすべき値は、`(設定温度) - 16`であると推測できます。
