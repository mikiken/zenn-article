---
title: "Pythonでエアコンのリモコン信号を解析し生成できるようにする"
emoji: "🦝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["HomeAutomation", "Python", "RaspberryPi"]
published: false
---

この記事は、[CAMPHOR- Advent Calendar 2023](https://advent.camph.net)の4日目の記事です。

### TL;DR
- ラズパイを使って、簡単なスマートリモコン[^1]を作った
- その際にエアコンのリモコン信号を解析したが、以外と大変だった
- エアコンのリモコン信号は、**運転状態を表すパラメータが全て送信される**
- Pythonからエアコンの運転状態に対応するリモコン信号を生成できるようにした

[^1]: 簡単にいえば、スマートフォンからエアコンを操作できるようにするデバイス。市販品としては、Switchbot や Nature Remo あたりが有名。

### はじめに
今年の夏は、めちゃくちゃ暑かったですね。帰宅前にエアコンをつけておきたいと思うことが多かった[^2]ので、スマートリモコンを作りました。

制作物の概要としては、Slackから`エアコンON`とか`温度上げて`みたいなメッセージを送ると、ラズパイに接続された赤外線LEDが信号を送信し、エアコンを操作するというものです。

本記事では、その際にエアコンのリモコン信号を解析した話をしようと思います。

[^2]: 帰宅時の部屋の室温が35℃とかになっていた

### リモコン信号の読み取り
Pythonで赤外線信号の読み取り・送信を行うためのスクリプトとして、[`irrp.py`](https://abyz.me.uk/rpi/pigpio/examples.html)が有名です。

今回は、以下の記事を参考に`irrp.py`を他のPythonスクリプトから呼び出しやすいように改変したものを使用しました。[^3]
https://qiita.com/Cartelet/items/1a451ec0abf5734aceae

[^3]: 記事を書いてる途中に調べてたら[PyPiに`irrp`というパッケージがあった。](https://pypi.org/project/irrp/)こっちの方がコマンド一発で入るので良さそう

`irrp.py`(改変版)を用いると、以下のようなPythonコードでリモコン信号を読み取ることができます。

```python
from irrp import IRRP

JSON_PATH = "code/mitsubishi_aircon.json"
POST_TIME = 130 # 信号が終了したと判断する時間（単位はms）
RECV_PIN = 18   # ラズパイに接続した赤外線受信モジュールのGPIOピン番号

ir = IRRP(file=JSON_PATH, post=POST_TIME, no_confirm=True)

ir.Record(GPIO=RECV_PIN, ID="ac:16")
ir.stop()
```

このコードを実行し、赤外線受光モジュールに向けてリモコンのボタンを押すと、以下のようなJSONファイルが出力されます。

```json
{"ac:16": [3446, 1652, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 1218, 477, 12982, 3446, 1652, 477, 1218, 477, 1218, 477, 368, 477, 368, 553, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 1218, 477]}
```

このJSONファイルには、前から順に赤外線LEDの点灯時間と消灯時間 (単位は`μs`) が交互に記録されています。
赤外線LEDの点灯時間と消灯時間の比によって、bitの0/1を表現しています。

### リモコン信号のフォーマット

### エアコンのリモコン信号解析の難しさ

### 実際に解析する