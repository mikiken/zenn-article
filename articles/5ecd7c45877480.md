---
title: "Pythonでエアコンのリモコン信号を解析し生成できるようにする"
emoji: "🦝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["HomeAutomation", "Python", "RaspberryPi"]
published: false
---

この記事は、[CAMPHOR- Advent Calendar 2023](https://advent.camph.net)の4日目の記事です。

## TL;DR
- ラズパイを使って、簡単なスマートリモコン[^1]を作った
- その際にエアコンのリモコン信号を解析したが、以外と大変だった
- エアコンのリモコン信号は、**運転状態を表すパラメータが全て送信される**
- Pythonからエアコンの運転状態に対応するリモコン信号を生成できるようにした

[^1]: 簡単にいえば、スマートフォンからエアコンを操作できるようにするデバイス。市販品としては、Switchbot や Nature Remo あたりが有名。

## はじめに
今年の夏は、めちゃくちゃ暑かったですね。帰宅前にエアコンをつけておきたいと思うことが多かった[^2]ので、スマートリモコンを作りました。

https://twitter.com/mikikeen/status/1707810093440577627

製作物の概要としては、Slackから`エアコンON`とか`温度上げて`みたいなメッセージを送ると、ラズパイに接続された赤外線LEDが信号を送信し、エアコンを操作するというものです。

本記事では、その際にエアコンのリモコン信号を解析した話をしようと思います。

[^2]: 帰宅時の部屋の室温が33℃とかになっていた

## リモコン信号の読み取り
Pythonで赤外線信号の読み取り・送信を行うためのスクリプトとして、[`irrp.py`](https://abyz.me.uk/rpi/pigpio/examples.html)が有名です。

今回は、以下の記事を参考に`irrp.py`を他のPythonスクリプトから呼び出しやすいように改変したものを使用しました。[^3]
https://qiita.com/Cartelet/items/1a451ec0abf5734aceae

[^3]: 記事を書いてる途中に調べてたら[PyPiに`irrp`というパッケージがあった。](https://pypi.org/project/irrp/)こっちの方がコマンド一発で入るので良さそう

`irrp.py`(改変版)を用いると、以下のようなPythonコードでリモコン信号を読み取ることができます。

```python
from irrp import IRRP

JSON_PATH = "code/mitsubishi_aircon.json"
POST_TIME = 130 # 信号が終了したと判断する時間（単位はms）
RECV_PIN = 18   # ラズパイに接続した赤外線受信モジュールのGPIOピン番号

ir = IRRP(file=JSON_PATH, post=POST_TIME, no_confirm=True)

ir.Record(GPIO=RECV_PIN, ID="ac:16")
ir.stop()
```

このコードを実行し、赤外線受光モジュールに向けてリモコンのボタンを押すと、以下のようなJSONファイルが出力されます。

```json
{"ac:16": [3446, 1652, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 1218, 477, 12982, 3446, 1652, 477, 1218, 477, 1218, 477, 368, 477, 368, 553, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 1218, 477]}
```

このJSONファイルには、前から順に赤外線LEDの点灯時間と消灯時間 (単位は`μs`) が交互に記録されています。
一般に赤外線リモコンでは、**赤外線LEDの点灯時間と消灯時間の比によって、送信信号のbitの0/1を表現しています**。そのため、読み取ったJSONファイルに記録されているLEDの点灯時間と消灯時間の比を調べ、まずはバイナリのデータにデコードすることが、赤外線リモコン信号の解析の第一歩となります。

## 赤外線リモコンの通信フォーマット
リモコン信号のバイナリデータを、赤外線LEDの点灯時間・消灯時間としてエンコードするフォーマットとして、主に以下の3種類が用いられています[^4]。

- NECフォーマット
- AEHA[^5]フォーマット
- SONYフォーマット

[^4]: もちろん例外もあり、例えばJVCは独自フォーマットを採用している。また、海外メーカー製のリモコンだと、別のフォーマットが用いられていることが多い(ちゃんと調べてない)。
[^5]: [一般財団法人 家電製品協会 (Association for Electric Home Appliances)](https://aeha.or.jp/)

:::message
なお、各フォーマットの詳細については、以下のサイトで詳しく説明されています。
http://elm-chan.org/docs/ir_format.html
:::

リモコン信号を解析するためには、まず解析対象のリモコンがどのフォーマットに準拠しているのかを調べる必要があります。

SONYフォーマットなどの独自フォーマットは、そのメーカーの製品のリモコンにしか使われていないため、すぐに判別できます。一方、NECフォーマットやAEHAフォーマットは、複数メーカーの製品のリモコンで用いられているため、**送信信号のLeader部[^6]を調べ、どのフォーマットに準拠しているのかを判別する**必要があります。

[^6]: フレーム(送信信号の1単位)の開始を表す箇所。1つのフレームは、Leader部, Data部, Trailer部からなり、これが送信信号の1単位となる。多くのリモコンでは、同じフレームを複数回送信し、信号を確実に送信できるようになっている。

## 実際に信号を解析してみる
それでは、実際にリモコンの信号を解析してみましょう。
今回は、三菱電機の霧ヶ峰のエアコン(型番:NA053)の信号を解読してみようと思います。

<!--ここにリモコンの写真を貼る-->

まず、リモコンの設定を

- 冷房16℃
- 風速:自動
- 風向(上下):自動
- 風向(左右):スイング

に設定した際の信号を、以下に示します。

```json
{"ac:16": [3446, 1652, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 1218, 477, 12982, 3446, 1652, 477, 1218, 477, 1218, 477, 368, 477, 368, 553, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 553, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 1218, 477, 368, 477, 368, 477, 368, 477, 1218, 477, 368, 477, 1218, 477]}
```

### 通信フォーマットの判別
上記の信号において、始めの点灯時間と消灯時間の組である、

```
[3446, 1652]
```

の部分がLeader部です。AEHAフォーマットの変調単位[^7]$T=425\,\rm{[\mu s]}$でこの値を割ってみると、

[^7]: 赤外線LEDを点灯・消灯させる時間の最小単位。AEHAフォーマットでは、$T= 350\sim 500\,\rm{[\mu s]}$の範囲で設定でき、$425\,\rm{[\mu s]}$あたりがよく用いられる。


```
[8.10, 3.89]
```

となります。この値は、AEHAフォーマットのLeader部の長さである[$8T$, $4T$]に近い値であることから、この信号は**AEHAフォーマットに準拠していると判断できます**。

### バイナリデータにデコードする
Leader部と同様に、Data部についても$T=425\,\rm{[\mu s]}$で割ってみると、

```
[1.12, 2.87, 1.12, 2.87, 1.12, 0.87, ...]
```

となります。AEHAフォーマットにおいて、$0$ のbitは [$T$, $T$]、$1$ のbitは [$T$, $3T$] で表現されるため、この信号は以下のようにデコードできます。

```
[1, 1, 0, ...]
```

この作業を、信号全体に対して行うことで、リモコン信号のバイナリデータが得られます。もちろん手作業だと大変なので、以下のようなPythonのコードを書きました。

```python
# 入力された赤外線LEDの点灯・消灯時間を変調単位で割り、正規化する
def normalize(code, T=425):
    normalized_code = []
    frame = []
    for i in range(0, len(code)):
        period = round(code[i] / T)
        # Trailer(Frame終端)の場合
        if period > 8:
            normalized_code.append(frame)
            frame = []
        else:
            frame.append(period)
    normalized_code.append(frame)
    return normalized_code


# AEHAフォーマットに従って、信号をバイナリデータにデコードする
def decode_to_binary(normalized_code):
    block = []
    data_frame = ""
    for frame in normalized_code:
        for i in range(0, len(frame) - 1, 2):
            # Leader
            if frame[i] == 8 and frame[i + 1] == 4:
                continue
            # 0 (Data bit)
            elif frame[i] == 1 and frame[i + 1] == 1:
                data_frame += "0"
            # 1 (Data bit)
            elif frame[i] == 1 and frame[i + 1] == 3:
                data_frame += "1"
            else:
                raise ("Unabled to decode.")
        block.append(data_frame)
        data_frame = ""

    # 全てのフレームが同一であるかを確認
    assert all(
        df == block[0] for df in block
    ), "Each data frame is not identical."

    return block[0], len(block)
```

このコードを用いると、上記のリモコン信号は以下のバイナリデータにデコードされます。

```
110001001101001101100100100000000000000000000100000110100000000001100011000000100000000000000000000000000000000000001000000000000000000011000101
```

### バイナリデータをパースする
AEHAフォーマットにおいて、Data部のバイナリデータは最下位bitから上位bitの順に並んでいます。[^8]

[^8]: AEHAフォーマットに限った話ではなく、NECフォーマットやSONYフォーマットでもLSB→MSBの順に並んでいる

![[AEHAフォーマットの概要](http://elm-chan.org/docs/rc/ir_aeha.png)](http://elm-chan.org/docs/rc/ir_aeha.png)*AEHAフォーマットの概要 (http://elm-chan.org/docs/ir_format.html より引用)*

また、Data部は以下のようなフィールドから構成されています。

| 名称 | データ長 | 概要 |
| :----: | :----: | :----: |
| Customer Code1 | 8bit | メーカーの識別に用いられる |
| Customer Code2 | 8bit | 同上 |
| Parity | 4bit | 誤り訂正用 (Customer Codeを4bitごとにXORした値) |
| Data0 | 4bit | |
| Data1 | 8bit | |
| Data2 | 8bit | |
| ︙ || |
| DataN | 8bit | | 

ここで、**データ長が4bitのフィールドがあることに注意する必要があります**。
バイナリデータのパース結果は、見やすさのために16進表記することが多いですが、単に前から8bitずつパースして、その結果を16進表記すると、ParityフィールドとData0フィールドの順序が逆になってしまいます。[^9]

[^9]: 後述しますが、このことを理解した上で、単に前から8bitずつパースする手抜き実装を採用しました()

以上の点を考慮すると以下のようなコードを用いることで、バイナリデータをパースすることができます。

```python
def parse_binary_code(binary_code):
    customer_code1 = int(binary_code[7::-1], 2)
    customer_code2 = int(binary_code[15:7:-1], 2)
    parity_code = int(binary_code[19:15:-1], 2)
    data0 = int(binary_code[23:19:-1], 2)
    binary_code = binary_code[24:]
    data = []
    while len(binary_code) > 0:
        data.append(int(binary_code[7::-1], 2))
        binary_code = binary_code[8:]
    data.insert(0, data0)

    frame = {
        "customer_code1": customer_code1,
        "customer_code2": customer_code2,
        "parity_code": parity_code,
        "data": data,
    }

    return frame
```

## エアコンのリモコン信号解析の難しさ